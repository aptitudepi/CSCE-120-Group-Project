# Test suite CMakeLists.txt

cmake_minimum_required(VERSION 3.21)

# Always use FetchContent for GoogleTest to avoid library conflicts with conda/miniconda
# This ensures we use a version that's compatible with system Qt6 and libstdc++
include(FetchContent)
FetchContent_Declare(
    googletest
    GIT_REPOSITORY https://github.com/google/googletest.git
    GIT_TAG release-1.12.1
)
FetchContent_MakeAvailable(googletest)

# Enable testing
enable_testing()

# Test sources
set(TEST_SOURCES
    test_main.cpp
    models/test_WeatherData.cpp
    services/test_WeatherService.cpp
    services/test_NWSService.cpp
    services/test_CacheManager.cpp
    integration/test_EndToEnd.cpp
)

# Create test executable
add_executable(HyperlocalWeatherTests ${TEST_SOURCES})

# Link test executable with application code and Google Test
target_link_libraries(HyperlocalWeatherTests PRIVATE
    Qt6::Core
    Qt6::Network
    Qt6::Sql
    GTest::gtest
    GTest::gtest_main
)

# Configure RPATH to avoid conda/miniconda library conflicts
# The issue: conda's libstdc++ is older and incompatible with Qt6
# Solution: Explicitly set RPATH via linker flags to system library paths only
set_target_properties(HyperlocalWeatherTests PROPERTIES
    BUILD_WITH_INSTALL_RPATH FALSE
    INSTALL_RPATH_USE_LINK_PATH FALSE
    SKIP_BUILD_RPATH TRUE  # Skip automatic RPATH, we'll set it manually
)

# Always set explicit RPATH to system libraries (helps even without conda)
# If conda is present, this ensures conda paths are not used
target_link_options(HyperlocalWeatherTests PRIVATE
    -Wl,-rpath,/usr/lib/x86_64-linux-gnu
    -Wl,-rpath,/lib/x86_64-linux-gnu
)

if(DEFINED ENV{CONDA_PREFIX})
    message(STATUS "Conda detected. Configured test executable to use system libraries only (excluding conda)")
    message(STATUS "RPATH set to: /usr/lib/x86_64-linux-gnu:/lib/x86_64-linux-gnu")
endif()

# Include application source directories
target_include_directories(HyperlocalWeatherTests PRIVATE
    ${CMAKE_SOURCE_DIR}/src
)

# Add application sources to test (except main.cpp)
target_sources(HyperlocalWeatherTests PRIVATE
    ${CMAKE_SOURCE_DIR}/src/models/WeatherData.cpp
    ${CMAKE_SOURCE_DIR}/src/models/ForecastModel.cpp
    ${CMAKE_SOURCE_DIR}/src/models/AlertModel.cpp
    ${CMAKE_SOURCE_DIR}/src/services/WeatherService.cpp
    ${CMAKE_SOURCE_DIR}/src/services/NWSService.cpp
    ${CMAKE_SOURCE_DIR}/src/services/PirateWeatherService.cpp
    ${CMAKE_SOURCE_DIR}/src/services/CacheManager.cpp
    ${CMAKE_SOURCE_DIR}/src/controllers/WeatherController.cpp
    ${CMAKE_SOURCE_DIR}/src/controllers/AlertController.cpp
    ${CMAKE_SOURCE_DIR}/src/database/DatabaseManager.cpp
    ${CMAKE_SOURCE_DIR}/src/nowcast/NowcastEngine.cpp
)

# Discover tests for CTest
include(GoogleTest)
gtest_discover_tests(HyperlocalWeatherTests)

# Add custom test target
add_custom_target(check
    COMMAND ${CMAKE_CTEST_COMMAND} --output-on-failure
    DEPENDS HyperlocalWeatherTests
    COMMENT "Running tests..."
)

# Coverage target (optional, requires gcov/lcov)
if(CMAKE_BUILD_TYPE STREQUAL "Debug" AND ENABLE_COVERAGE)
    target_compile_options(HyperlocalWeatherTests PRIVATE --coverage)
    target_link_options(HyperlocalWeatherTests PRIVATE --coverage)
    
    add_custom_target(coverage
        COMMAND lcov --capture --directory . --output-file coverage.info
        COMMAND lcov --remove coverage.info '/usr/*' '*/tests/*' --output-file coverage.info
        COMMAND genhtml coverage.info --output-directory coverage
        WORKING_DIRECTORY ${CMAKE_BINARY_DIR}
        DEPENDS check
        COMMENT "Generating coverage report..."
    )
endif()
